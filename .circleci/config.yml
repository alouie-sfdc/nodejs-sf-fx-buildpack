# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2.1
jobs:

  # build job runs for all branches and all tags.
  build:
    docker:
      # Specify the version you desire here
      # https://circleci.com/docs/2.0/circleci-images/#nodejs
      - image: circleci/node:lts

    # set working directory to sub folder
    working_directory: ~/repo/middleware

    steps:
      - checkout:
          path: ~/repo

      - run:  # Access to @heroku/salesforce-sdk
          name: Middleware Build and Test Prep
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      - run: npm install
      - run: npm run build
      - run: npm run test
      - run:
          name: Setup Bash Shell Environment Variables
          command: |
              echo "export VERSION_TOML=v$(cat ~/repo/buildpack.toml | grep -m 1 version | sed -e 's/version = //g' | xargs)" >> $BASH_ENV
              echo "export RELEASE_TAG=`curl -H "Authorization: token ${GITHUB_CI_TOKEN}" --silent "https://api.github.com/repos/forcedotcom/sf-fx-middleware/releases" | jq -r '.[0].tag_name'`" >> $BASH_ENV      
      - run: echo "VERSION_TOML is " $VERSION_TOML  && echo "RELEASE_TAG is " $RELEASE_TAG
      - run:
          name: Tag repository if verion in build.toml changed when merged to master/develop
          command: |
              if [ "$VERSION_TOML" = "$RELEASE_TAG" ] && [ "$CIRCLE_BRANCH" = "jqian/detectsdk" ]; then
                echo "branch is " $CIRCLE_BRANCH
                echo "git tag it"
              else
                echo "tag already existed"
              fi
      #save the packaged tgz for release job to use
      - run: cd .. && make package && ls -alh sf-fx-middleware-buildpack-*.tgz
      - persist_to_workspace:
          root: ~/repo
          paths:
            - sf-fx-middleware-buildpack-*.tgz

  #release job runs for no branches and only for tags starting with ‘v’.        
  release: 
    docker:
      - image: cibuilds/github:0.13.0
          # set working directory to sub folder
    working_directory: ~/repo

    steps:
      - checkout
      - run: echo "ghr is installed on " $(which ghr)
      - run: echo "run github command to upload the binary on " ${CIRCLE_BRANCH}:${CIRCLE_TAG}
      - attach_workspace:
          at: ~/repo
      - run: ls -alh sf-fx-middleware-buildpack-*.tgz
      - add_ssh_keys:
          fingerprints:
            - "27:9b:35:37:91:09:f0:67:71:1c:37:5b:82:55:14:1c"
      - run: ./ci-git-release.sh

workflows:
  version: 2
  build-and-release:
    jobs:
      - build
      - release:
          requires:
            - build
  
